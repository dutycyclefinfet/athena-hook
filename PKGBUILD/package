#!/usr/bin/env bash

pkgnames=(athena-hook)
url="https://github.com/dutycyclefinfet/athena-hook"
pkgver=$(cat version)
timestamp=$(date +"%Y-%m-%dT%H:%M:%S%z")
pkgdesc="Athena hook"
section="utils"
maintainer="Lonely Transistor <lonelytransistor@protonmail.com>"
installdepends=(athena-linux)
license=GPL-3.0-or-later
image=qt:v2.2.2
makedepends=()

source=()
sha256sums=()

prepare() {
    git clone --depth 1 https://github.com/dutycyclefinfet/athena-hook "${srcdir}"
}

build() {
    cd Hook
    qmake
    make -j$(nproc)
}

function _install() {
    if [ "$1" == "-r" ]; then
        (
            cd "${@:$#-1:1}"
            for f in $(find . -type f); do
                install -D "${@:2:$#-3}" "$f" "${@:$#}/$f"
            done
        )
    else
        install "$@"
    fi
}
package() {
    _install -r -m 644 -D "${srcdir}/OPKGPlugin" "${pkgdir}/home/root/.xochitlPlugins/AthenaOPKG"
    _install -r -m 644 -D "${srcdir}/CorePlugin/common" "${pkgdir}/home/root/.xochitlPlugins/.common"
    
    _install -r -m 644 -D "${srcdir}/CorePlugin/hook.qml" "${pkgdir}/usr/libexec/athenaXochitl"
    _install -m 644 -D "${srcdir}/Hook/adjust-epd.service" "${pkgdir}/lib/systemd/system/adjust-epd.service"
    _install -m 755 -D "${srcdir}/Hook/libAthenaXochitl.so.1.0.0" "${pkgdir}/usr/libexec/libAthenaXochitl.so"
    _install -m 755 -D "${srcdir}/Hook/athenaHelper.sh" "${pkgdir}/usr/libexec/athenaHelper"
    
    _install -m 644 -D "${srcdir}/Hook/epd" "${pkgdir}/etc/athena/epd"
    _install -m 644 -D "${srcdir}/Hook/zram" "${pkgdir}/etc/athena/zram"
    _install -m 644 -D "${srcdir}/Hook/usb" "${pkgdir}/etc/athena/usb"
    _install -m 644 -D "${srcdir}/Hook/usb_modes" "${pkgdir}/etc/athena/usb_modes"
}
